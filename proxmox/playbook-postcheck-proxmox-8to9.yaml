---
- name: Postcheck Proxmox VE 9 Host Health
  hosts: proxmox_server
  become: false
  gather_facts: false
  serial: 1

  vars:
    pve_expected_target_major: "9"

  tasks:
    - name: Read current Proxmox version
      ansible.builtin.command: /usr/bin/pveversion
      register: pveversion_cmd
      changed_when: false

    - name: Extract current Proxmox major version
      ansible.builtin.set_fact:
        pve_current_major: "{{ pveversion_cmd.stdout | regex_search('pve-manager/(\\d+)\\.', '\\1') | first | default('unknown') }}"

    - name: Assert host is on expected target major version
      ansible.builtin.assert:
        that:
          - pve_current_major == pve_expected_target_major
        fail_msg: "Expected Proxmox major {{ pve_expected_target_major }}. Current: {{ pveversion_cmd.stdout }}"
        success_msg: "Host is on Proxmox major {{ pve_current_major }}"

    - name: Read high-level Proxmox package versions
      ansible.builtin.command: /usr/bin/pveversion -v
      register: pveversion_verbose
      changed_when: false

    - name: Check systemd overall state
      ansible.builtin.command: /bin/systemctl is-system-running
      register: systemd_state
      changed_when: false
      failed_when: false

    - name: Read VM inventory
      ansible.builtin.command: sudo -n /usr/sbin/qm list
      register: qm_list_cmd
      changed_when: false
      failed_when: false

    - name: Read container inventory
      ansible.builtin.command: sudo -n /usr/sbin/pct list
      register: pct_list_cmd
      changed_when: false
      failed_when: false

    - name: Check whether reboot is still required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_flag

    - name: Simulate upgrades to detect remaining pending packages
      ansible.builtin.command: /usr/bin/apt-get -s upgrade
      register: apt_simulated_upgrade
      changed_when: false
      retries: 6
      delay: 10
      until: apt_simulated_upgrade.rc == 0

    - name: Parse remaining pending package count
      ansible.builtin.set_fact:
        pending_upgrade_summary_line: >-
          {{
            (apt_simulated_upgrade.stdout_lines | select('search', 'upgraded,') | list | first)
            | default('summary line not found')
          }}

    - name: Report postcheck summary
      ansible.builtin.debug:
        msg:
          - "pveversion={{ pveversion_cmd.stdout }}"
          - "systemd_state={{ systemd_state.stdout | default('unknown') }}"
          - "reboot_required={{ reboot_required_flag.stat.exists }}"
          - "remaining_upgrade_summary={{ pending_upgrade_summary_line }}"
          - "qm_inventory_available={{ qm_list_cmd.rc == 0 }}"
          - "pct_inventory_available={{ pct_list_cmd.rc == 0 }}"
          - "pveversion_verbose_head={{ (pveversion_verbose.stdout_lines | list)[0:15] }}"
