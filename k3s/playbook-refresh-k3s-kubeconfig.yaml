---
- name: Refresh local kubeconfig from k3s controller
  hosts: proxmox_server
  gather_facts: false
  become: false
  vars:
    # If true, rotates k3s client/server certs when the controller's kubeconfig client cert is expired.
    k3s_kubeconfig_rotate_if_expired: true

    # When KUBECONFIG is not set, write to this directory on the control node.
    k3s_kubeconfig_default_dir: "{{ lookup('env', 'HOME') }}/.kube"

    # Override to force a specific API server hostname in the generated kubeconfig.
    # Example: -e k3s_kubeconfig_server=my-k3s.example.com
    k3s_kubeconfig_server: ""

    k3s_api_port: 6443

  pre_tasks:
    - name: Ensure inventory defines a k3s controller
      ansible.builtin.assert:
        that:
          - groups['k3s_controller'] is defined
          - (groups['k3s_controller'] | length) > 0
        fail_msg: "Inventory must define at least one host in the [k3s_controller] group."
      run_once: true

    - name: Derive controller container details
      ansible.builtin.set_fact:
        k3s_controller_host: "{{ groups['k3s_controller'] | first }}"
        k3s_controller_pct_id: "{{ hostvars[groups['k3s_controller'] | first].pct_id }}"
      run_once: true

    - name: Determine API hostname for kubeconfig server field
      ansible.builtin.set_fact:
        k3s_api_host: >-
          {{
            (k3s_kubeconfig_server | length > 0)
              | ternary(
                k3s_kubeconfig_server,
                (hostvars[k3s_controller_host].node_name | default(k3s_controller_host, true))
              )
          }}
      run_once: true

    - name: Determine kubeconfig output path on the control node
      ansible.builtin.set_fact:
        k3s_kubeconfig_output_path: >-
          {{
            (
              (lookup('env', 'KUBECONFIG') | default('', true)).split(':') | first
            )
              | default(k3s_kubeconfig_default_dir ~ '/k3s-' ~ k3s_api_host ~ '.config', true)
              | regex_replace('^~', lookup('env', 'HOME'))
          }}
      run_once: true

  tasks:
    - name: Read kubeconfig from controller container
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_controller_pct_id }}"
          - --
          - cat
          - /etc/rancher/k3s/k3s.yaml
      register: k3s_remote_kubeconfig
      changed_when: false
      run_once: true

    - name: Check if k3s admin client certificate is expired on controller
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_controller_pct_id }}"
          - --
          - sh
          - -c
          - "openssl x509 -checkend 0 -noout -in /var/lib/rancher/k3s/server/tls/client-admin.crt"
      register: k3s_admin_client_cert_check
      changed_when: false
      failed_when: k3s_admin_client_cert_check.rc not in [0, 1]
      run_once: true

    - name: Determine whether k3s admin client certificate is expired
      ansible.builtin.set_fact:
        k3s_admin_client_cert_expired: "{{ k3s_admin_client_cert_check.rc == 1 }}"
      run_once: true

    - name: Stop k3s on controller before rotating certificates (expired admin cert)
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_controller_pct_id }}"
          - --
          - systemctl
          - stop
          - k3s
      when:
        - k3s_kubeconfig_rotate_if_expired
        - k3s_admin_client_cert_expired
      run_once: true

    - name: Rotate k3s client and server certificates on controller (expired admin cert)
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_controller_pct_id }}"
          - --
          - /usr/local/bin/k3s
          - certificate
          - rotate
      when:
        - k3s_kubeconfig_rotate_if_expired
        - k3s_admin_client_cert_expired
      run_once: true

    - name: Start k3s on controller after rotating certificates
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_controller_pct_id }}"
          - --
          - systemctl
          - start
          - k3s
      when:
        - k3s_kubeconfig_rotate_if_expired
        - k3s_admin_client_cert_expired
      run_once: true

    - name: Wait for k3s service to be active after rotating certificates
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_controller_pct_id }}"
          - --
          - systemctl
          - is-active
          - k3s
      register: k3s_service_active_check
      changed_when: false
      retries: 30
      delay: 2
      until: k3s_service_active_check.stdout | trim == 'active'
      when:
        - k3s_kubeconfig_rotate_if_expired
        - k3s_admin_client_cert_expired
      run_once: true

    - name: Re-read kubeconfig from controller after certificate rotation
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_controller_pct_id }}"
          - --
          - cat
          - /etc/rancher/k3s/k3s.yaml
      register: k3s_remote_kubeconfig_after_rotate
      changed_when: false
      when:
        - k3s_kubeconfig_rotate_if_expired
        - k3s_admin_client_cert_expired
      run_once: true

    - name: Choose kubeconfig content (post-rotate if applicable)
      ansible.builtin.set_fact:
        k3s_remote_kubeconfig_content: >-
          {{
            (k3s_remote_kubeconfig_after_rotate.stdout
              | default(k3s_remote_kubeconfig.stdout, true))
          }}
      no_log: true
      run_once: true

    - name: Replace localhost API server with the controller API hostname
      ansible.builtin.set_fact:
        k3s_kubeconfig_normalized: >-
          {{
            k3s_remote_kubeconfig_content
            | replace(
              'https://127.0.0.1:' ~ (k3s_api_port | string),
              'https://' ~ k3s_api_host ~ ':' ~ (k3s_api_port | string)
            )
            | replace(
              'https://localhost:' ~ (k3s_api_port | string),
              'https://' ~ k3s_api_host ~ ':' ~ (k3s_api_port | string)
            )
          }}
      no_log: true
      run_once: true

    - name: Ensure kubeconfig output directory exists on the control node
      ansible.builtin.file:
        path: "{{ k3s_kubeconfig_output_path | dirname }}"
        state: directory
        mode: "0700"
      delegate_to: localhost
      run_once: true

    - name: Write kubeconfig to the control node
      ansible.builtin.copy:
        dest: "{{ k3s_kubeconfig_output_path }}"
        content: "{{ k3s_kubeconfig_normalized }}"
        mode: "0600"
        unsafe_writes: true
      delegate_to: localhost
      no_log: true
      run_once: true

    - name: Show kubeconfig output path
      ansible.builtin.debug:
        msg: "Wrote refreshed kubeconfig to {{ k3s_kubeconfig_output_path }}"
      run_once: true
