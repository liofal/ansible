---
- name: Upgrade k3s on Proxmox nodes
  hosts: proxmox_server
  gather_facts: false
  become: false
  vars:
    # Optional: set with -e k3s_target_version=vX.Y.Z+k3sN to pin a specific version.
    k3s_target_version: ""
    k3s_release_channel: "stable"

    # Keep controllers unschedulable for regular workloads.
    # Override if needed, e.g. -e k3s_controller_node_taint="node-role.kubernetes.io/control-plane=true:NoSchedule"
    k3s_controller_node_taint: "node-role.kubernetes.io/control-plane=true:NoSchedule"
  pre_tasks:
    - name: Determine K3s shared token
      ansible.builtin.set_fact:
        k3s_token: "{{ lookup('env', 'K3S_TOKEN') | default(env_token_from_file, true) }}"
      vars:
        env_contents: "{{ lookup('file', '../.env', errors='ignore') | default('') }}"
        env_token_from_file: "{{ (env_contents | regex_findall('(?:export\\s+)?K3S_TOKEN=([^\\n]+)') | first | default('', true) | trim | regex_replace('^\"|\"$', '')) }}"

    - name: Fail if K3s shared token is unavailable
      ansible.builtin.fail:
        msg: "K3S_TOKEN is missing. Export it in your environment or add it to .env."
      when: k3s_token | length == 0
    - name: Build list of upgrade target hosts
      ansible.builtin.set_fact:
        k3s_upgrade_target_hosts: "{{ ((groups['k3s_controller'] | default([])) + (groups['k3s_workers'] | default([]))) | unique }}"

    - name: Ensure upgrade target host list is not empty
      ansible.builtin.assert:
        that:
          - (k3s_upgrade_target_hosts | length) > 0
        fail_msg: "No k3s_controller/k3s_workers hosts were found in inventory."

    - name: Check PCT status for upgrade target hosts
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - status
          - "{{ hostvars[item].pct_id }}"
      loop: "{{ k3s_upgrade_target_hosts }}"
      register: k3s_upgrade_pct_status
      changed_when: false
      failed_when: false
      loop_control:
        label: "{{ hostvars[item].node_name | default(item, true) }}"

    - name: Fail when an upgrade target PCT is not running
      ansible.builtin.fail:
        msg: >-
          PCT {{ hostvars[item.item].pct_id }} ({{ hostvars[item.item].node_name | default(item.item, true) }})
          is '{{ item.stdout | default('unknown', true) | trim }}'.
          Start the container before running k3s upgrade.
      loop: "{{ k3s_upgrade_pct_status.results }}"
      when: (item.stdout | default('')) is not search('status:\s*running')
      loop_control:
        label: "{{ hostvars[item.item].node_name | default(item.item, true) }}"
  tasks:
    - name: Normalize optional target version override
      ansible.builtin.set_fact:
        k3s_target_version: "{{ k3s_target_version | trim }}"
      run_once: true

    - name: Get latest stable K3s version from update endpoint
      ansible.builtin.uri:
        url: "https://update.k3s.io/v1-release/channels/{{ k3s_release_channel }}"
        headers:
          Accept: "application/json"
        follow_redirects: all
        return_content: true
      register: k3s_stable_channel_info
      run_once: true
      delegate_to: localhost
      when: k3s_target_version | length == 0

    - name: Extract latest K3s version string from endpoint response
      ansible.builtin.set_fact:
        k3s_target_version: >-
          {{
            (
              k3s_stable_channel_info.json.tag_name
              | default(
                  (
                    k3s_stable_channel_info.content
                    | regex_findall('"tag_name"\\s*:\\s*"([^"]+)"')
                    | first
                    | default('')
                  ),
                  true
                )
            ) | trim
          }}
      run_once: true
      when: k3s_target_version | length == 0

    - name: Fail if target version could not be determined
      ansible.builtin.fail:
        msg: >-
          Could not determine the target K3s version.
          Provide -e k3s_target_version=vX.Y.Z+k3sN, or check update endpoint response.
      when: k3s_target_version == ''
      run_once: true

    - name: Validate target K3s version format
      ansible.builtin.assert:
        that:
          - k3s_target_version is match('^v[0-9]+\\.[0-9]+\\.[0-9]+\\+k3s[0-9]+$')
        fail_msg: "k3s_target_version '{{ k3s_target_version }}' is not a valid k3s version string."
      run_once: true

    - name: Display determined target K3s version
      ansible.builtin.debug:
        msg: "Target K3s version: {{ k3s_target_version }} (channel={{ k3s_release_channel }})"
      run_once: true

    - name: Include worker upgrade tasks
      ansible.builtin.include_tasks: _upgrade_worker_tasks.yaml
      loop: "{{ groups['k3s_workers'] }}"
      when: groups['k3s_workers'] is defined
      loop_control:
        label: "{{ hostvars[item].node_name }}"

    # Controller upgrade must happen AFTER workers, as controller is needed for kubectl drain/uncordon
    - name: Check current k3s version on controller {{ hostvars[item].node_name }}
      ansible.builtin.shell: |
        sudo /usr/sbin/pct exec {{ hostvars[item].pct_id }} -- bash -c "/usr/local/bin/k3s --version | head -n1 | cut -d' ' -f3"
      loop: "{{ groups['k3s_controller'] }}"
      when: groups['k3s_controller'] is defined
      register: k3s_controller_version_output
      changed_when: false
      loop_control:
        label: "{{ hostvars[item].node_name }}"

    - name: Build controller version inventory for comparison
      ansible.builtin.set_fact:
        k3s_controller_versions: >-
          {{
            (k3s_controller_versions | default([]))
            + [{
              'host': item.item,
              'current': (item.stdout | trim)
            }]
          }}
      loop: "{{ k3s_controller_version_output.results }}"
      when: k3s_controller_version_output.results is defined
      loop_control:
        label: "{{ hostvars[item.item].node_name }}"

    - name: Display current k3s version for controller {{ hostvars[item.host].node_name }}
      ansible.builtin.debug:
        msg: "Node {{ hostvars[item.host].node_name }} has k3s version: {{ item.current | default('unknown', true) }}. Target: {{ k3s_target_version }}"
      loop: "{{ k3s_controller_versions | default([]) }}"
      loop_control:
        label: "{{ hostvars[item.host].node_name }}"

    # noqa pipefail
    - name: Upgrade k3s controller node {{ hostvars[item.host].node_name }}
      ansible.builtin.shell: |
        sudo /usr/sbin/pct exec {{ hostvars[item.host].pct_id }} -- bash -c "set -o pipefail && curl -fsL https://get.k3s.io | \
        INSTALL_K3S_SKIP_SELINUX_RPM=true INSTALL_K3S_VERSION={{ k3s_target_version }} sh -s - --disable traefik --node-name {{ hostvars[item.host].node_name }} --node-taint {{ k3s_controller_node_taint }}"
      loop: "{{ k3s_controller_versions | default([]) }}"
      when: item.current != k3s_target_version
      register: upgrade_controller_result
      changed_when: upgrade_controller_result.stdout | regex_search('Downloading binary|Starting k3s')
      loop_control:
        label: "{{ hostvars[item.host].node_name }}"

    - name: Show upgrade result for controller node {{ hostvars[item.item.host].node_name }}
      ansible.builtin.debug:
        msg: "{{ item.stdout }}"
      loop: "{{ upgrade_controller_result.results | default([]) }}"
      when:
        - item.stdout is defined
        - item.stdout != ""
      loop_control:
        label: "{{ hostvars[item.item.host].node_name }}"
