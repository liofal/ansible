---
- name: Update Rocky Linux containers on Proxmox nodes
  hosts: proxmox_server
  gather_facts: false
  become: false
  tasks:
    - name: Update package list on Rocky Linux containers
      ansible.builtin.shell: |
        sudo -n /usr/sbin/pct exec {{ hostvars[item].pct_id }} -- bash -lc "dnf -q makecache --refresh"
      loop: "{{ groups['rockylinux_containers'] }}"
      when: groups['rockylinux_containers'] is defined
      register: update_cache
      changed_when: false

    - name: Ensure dnf-plugins-core is installed (for needs-restarting)
      ansible.builtin.shell: |
        sudo -n /usr/sbin/pct exec {{ hostvars[item].pct_id }} -- bash -lc "dnf -y install dnf-plugins-core"
      loop: "{{ groups['rockylinux_containers'] }}"
      when: groups['rockylinux_containers'] is defined
      changed_when: false

    - name: Upgrade packages on Rocky Linux containers
      ansible.builtin.shell: |
        sudo -n /usr/sbin/pct exec {{ hostvars[item].pct_id }} -- bash -lc "dnf -y upgrade"
      loop: "{{ groups['rockylinux_containers'] }}"
      when: groups['rockylinux_containers'] is defined
      register: upgrade_packages
      changed_when: "'Nothing to do.' not in upgrade_packages.stdout"

    - name: Check whether container restart is recommended
      ansible.builtin.shell: |
        sudo -n /usr/sbin/pct exec {{ hostvars[item].pct_id }} -- bash -lc "dnf needs-restarting -r >/dev/null 2>&1; echo $?"
      loop: "{{ groups['rockylinux_containers'] }}"
      when: groups['rockylinux_containers'] is defined
      register: restart_recommended
      changed_when: false

    - name: Report package upgrade and restart recommendation summary
      ansible.builtin.debug:
        msg: >-
          {{ item.item }}:
          upgraded={{ 'yes' if ('Nothing to do.' not in item.stdout) else 'no' }},
          restart_recommended={{ 'yes' if (restart_recommended.results[ansible_loop.index0].stdout | trim) == '1' else 'no' }}
      loop: "{{ upgrade_packages.results }}"
      loop_control:
        label: "{{ item.item }}"
        extended: true
