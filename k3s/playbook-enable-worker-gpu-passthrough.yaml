---
- name: Enable GPU passthrough for one k3s worker LXC
  hosts: proxmox_server
  gather_facts: false
  become: false
  vars:
    # Inventory host key in [k3s_workers], e.g. -e k3s_gpu_worker_host=k3sw2
    k3s_gpu_worker_host: ""
    k3s_gpu_drain_timeout: "300s"
    k3s_gpu_wait_timeout: "300s"

    # Optional node label management (useful for Plex scheduling by role)
    k3s_gpu_manage_label: true
    k3s_gpu_label_key: "workload.liofal.net/plex"
    k3s_gpu_label_value: "true"

    # Optional Plex volume permission repair in worker LXC
    k3s_gpu_fix_plex_permissions: true
    k3s_gpu_plex_uid: "568"
    k3s_gpu_plex_gid: "568"
    k3s_gpu_plex_paths:
      - /volumes/plex-config
      - /volumes/plex-cache

  pre_tasks:
    - name: Ensure inventory defines at least one k3s controller
      ansible.builtin.assert:
        that:
          - groups['k3s_controller'] is defined
          - (groups['k3s_controller'] | length) > 0
        fail_msg: "Inventory must define at least one host in the [k3s_controller] group."

    - name: Ensure a worker host was provided
      ansible.builtin.assert:
        that:
          - k3s_gpu_worker_host | trim | length > 0
        fail_msg: "Set -e k3s_gpu_worker_host=<inventory_host>."

    - name: Ensure selected worker host exists in inventory
      ansible.builtin.assert:
        that:
          - k3s_gpu_worker_host in hostvars
          - hostvars[k3s_gpu_worker_host].pct_id is defined
          - hostvars[k3s_gpu_worker_host].node_name is defined
        fail_msg: "Worker host '{{ k3s_gpu_worker_host }}' must exist and define pct_id + node_name."

    - name: Set controller and worker execution facts
      ansible.builtin.set_fact:
        k3s_gpu_controller_host: "{{ groups['k3s_controller'] | first }}"
        k3s_gpu_controller_pct_id: "{{ hostvars[groups['k3s_controller'] | first].pct_id }}"
        k3s_gpu_worker_pct_id: "{{ hostvars[k3s_gpu_worker_host].pct_id }}"
        k3s_gpu_worker_node_name: "{{ hostvars[k3s_gpu_worker_host].node_name }}"

  tasks:
    - name: Check host /dev/dri/card0 availability
      ansible.builtin.command:
        argv:
          - ls
          - -l
          - /dev/dri/card0
      register: k3s_gpu_host_card0
      changed_when: false
      failed_when: false

    - name: Fail when host /dev/dri/card0 is missing
      ansible.builtin.assert:
        that:
          - k3s_gpu_host_card0.rc == 0
        fail_msg: "Host /dev/dri/card0 is missing; GPU passthrough cannot be configured."

    - name: Read current LXC config
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - config
          - "{{ k3s_gpu_worker_pct_id }}"
      register: k3s_gpu_pct_config_before
      changed_when: false

    - name: Check whether /dev/dri/renderD128 exists on host
      ansible.builtin.command:
        argv:
          - ls
          - -l
          - /dev/dri/renderD128
      register: k3s_gpu_host_renderd128
      changed_when: false
      failed_when: false

    - name: Set GPU passthrough flags
      ansible.builtin.set_fact:
        k3s_gpu_has_card0: "{{ (k3s_gpu_pct_config_before.stdout | regex_search('(?m)^dev0:\\s+/dev/dri/card0$')) is not none }}"
        k3s_gpu_has_renderd128: "{{ (k3s_gpu_pct_config_before.stdout | regex_search('(?m)^dev1:\\s+/dev/dri/renderD128$')) is not none }}"
        k3s_gpu_should_set_renderd128: "{{ k3s_gpu_host_renderd128.rc == 0 }}"

    - name: Configure dev0 passthrough for /dev/dri/card0
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - set
          - "{{ k3s_gpu_worker_pct_id }}"
          - -dev0
          - /dev/dri/card0
      when: not k3s_gpu_has_card0
      register: k3s_gpu_set_dev0
      changed_when: true

    - name: Configure dev1 passthrough for /dev/dri/renderD128 when available
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - set
          - "{{ k3s_gpu_worker_pct_id }}"
          - -dev1
          - /dev/dri/renderD128
      when:
        - k3s_gpu_should_set_renderd128 | bool
        - not k3s_gpu_has_renderd128
      register: k3s_gpu_set_dev1
      changed_when: true

    - name: Check whether /dev/dri/card0 is already present in worker
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_gpu_worker_pct_id }}"
          - --
          - bash
          - -lc
          - test -c /dev/dri/card0
      register: k3s_gpu_card0_before
      changed_when: false
      failed_when: false

    - name: Decide whether worker restart is required
      ansible.builtin.set_fact:
        k3s_gpu_restart_required: >-
          {{
            (k3s_gpu_card0_before.rc != 0)
            or ((k3s_gpu_set_dev0 is defined) and (k3s_gpu_set_dev0 is changed))
            or ((k3s_gpu_set_dev1 is defined) and (k3s_gpu_set_dev1 is changed))
          }}

    - name: Cordon worker before LXC restart
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_gpu_controller_pct_id }}"
          - --
          - bash
          - -lc
          - >-
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml &&
            /usr/local/bin/kubectl cordon {{ k3s_gpu_worker_node_name }}
      when: k3s_gpu_restart_required | bool
      register: k3s_gpu_cordon
      changed_when: "'already cordoned' not in ((k3s_gpu_cordon.stdout | default('')) ~ (k3s_gpu_cordon.stderr | default('')))"
      failed_when: false

    - name: Drain worker before LXC restart
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_gpu_controller_pct_id }}"
          - --
          - bash
          - -lc
          - >-
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml &&
            /usr/local/bin/kubectl drain {{ k3s_gpu_worker_node_name }}
            --ignore-daemonsets --delete-emptydir-data --disable-eviction
            --timeout={{ k3s_gpu_drain_timeout }}
      when: k3s_gpu_restart_required | bool
      register: k3s_gpu_drain
      changed_when: "'drained' in (k3s_gpu_drain.stdout | default(''))"
      failed_when: >-
        (k3s_gpu_drain.rc != 0)
        and ('already cordoned' not in ((k3s_gpu_drain.stdout | default('')) ~ (k3s_gpu_drain.stderr | default(''))))

    - name: Stop worker LXC to apply passthrough config
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - stop
          - "{{ k3s_gpu_worker_pct_id }}"
      when: k3s_gpu_restart_required | bool
      register: k3s_gpu_stop
      changed_when: k3s_gpu_stop.rc == 0
      failed_when: false

    - name: Start worker LXC after passthrough config
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - start
          - "{{ k3s_gpu_worker_pct_id }}"
      when: k3s_gpu_restart_required | bool
      register: k3s_gpu_start
      changed_when: k3s_gpu_start.rc == 0

    - name: Wait for worker node to become Ready again
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_gpu_controller_pct_id }}"
          - --
          - bash
          - -lc
          - >-
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml &&
            /usr/local/bin/kubectl wait --for=condition=Ready node/{{ k3s_gpu_worker_node_name }}
            --timeout={{ k3s_gpu_wait_timeout }}
      when: k3s_gpu_restart_required | bool
      changed_when: false

    - name: Uncordon worker after restart
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_gpu_controller_pct_id }}"
          - --
          - bash
          - -lc
          - >-
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml &&
            /usr/local/bin/kubectl uncordon {{ k3s_gpu_worker_node_name }}
      when: k3s_gpu_restart_required | bool
      register: k3s_gpu_uncordon
      changed_when: "'uncordoned' in ((k3s_gpu_uncordon.stdout | default('')) ~ (k3s_gpu_uncordon.stderr | default('')))"
      failed_when: false

    - name: Ensure Plex hostPath permissions in worker LXC
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_gpu_worker_pct_id }}"
          - --
          - bash
          - -lc
          - >-
            set -eu;
            for p in {{ k3s_gpu_plex_paths | map('quote') | join(' ') }}; do
              mkdir -p "$p";
              chown -R {{ k3s_gpu_plex_uid }}:{{ k3s_gpu_plex_gid }} "$p";
              chmod 775 "$p";
            done
      when: k3s_gpu_fix_plex_permissions | bool
      register: k3s_gpu_plex_perms
      changed_when: true

    - name: Label worker node for GPU workload scheduling
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_gpu_controller_pct_id }}"
          - --
          - bash
          - -lc
          - >-
            export KUBECONFIG=/etc/rancher/k3s/k3s.yaml &&
            /usr/local/bin/kubectl label node {{ k3s_gpu_worker_node_name }}
            {{ k3s_gpu_label_key }}={{ k3s_gpu_label_value }} --overwrite
      when: k3s_gpu_manage_label | bool
      register: k3s_gpu_label
      changed_when: "'labeled' in ((k3s_gpu_label.stdout | default('')) ~ (k3s_gpu_label.stderr | default('')))"

    - name: Verify /dev/dri/card0 is exposed in worker LXC
      ansible.builtin.command:
        argv:
          - sudo
          - /usr/sbin/pct
          - exec
          - "{{ k3s_gpu_worker_pct_id }}"
          - --
          - bash
          - -lc
          - test -c /dev/dri/card0 && ls -l /dev/dri/card0
      register: k3s_gpu_verify
      changed_when: false

    - name: Print GPU passthrough summary
      ansible.builtin.debug:
        msg:
          - "worker={{ k3s_gpu_worker_host }} pct_id={{ k3s_gpu_worker_pct_id }} node={{ k3s_gpu_worker_node_name }}"
          - "configured_dev0={{ 'yes' if (k3s_gpu_set_dev0 is defined and (k3s_gpu_set_dev0 is changed)) else 'no' }}"
          - "configured_dev1={{ 'yes' if (k3s_gpu_set_dev1 is defined and (k3s_gpu_set_dev1 is changed)) else 'no' }}"
          - "restart_required={{ k3s_gpu_restart_required | bool }}"
          - "plex_permissions_fixed={{ 'yes' if (k3s_gpu_plex_perms is defined and (k3s_gpu_plex_perms is changed)) else 'no' }}"
          - "verify={{ k3s_gpu_verify.stdout | default('') | trim }}"
